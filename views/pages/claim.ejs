<html>
  <head>
    <!-- jQuery -->
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <!-- END jQuery-->

    <!-- Bootstrap -->
    <link
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.2.0/css/all.css"
      integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
      crossorigin="anonymous"
    />
    <script type="text/javascript">
      function getFormData($form) {
        var unindexed_array = $form.serializeArray();
        var indexed_array = {};

        $.map(unindexed_array, function(n, i) {
          indexed_array[n["name"]] = n["value"];
        });

        return indexed_array;
      }

      function displayLoading(){
        $('#submitBtn').html('<span class="spinner-border spinner-border-sm text-light" role="status"> <span class="sr-only"></span></span> Loading ...')
        $('#submitBtn').attr('disabled',true);
      }

      function displayClaimNow(){
        $('#submitBtn').html('Claim Now');
        $('#submitBtn').attr('disabled',false);
      }

      function onSubmit(e) {
        e.preventDefault();
        var $form = $("#claimForm");
        var data = getFormData($form);
        if (!data.address) {
          return showError("The address is required");
        }
        displayLoading();
        $.post("/taps", data)
          .then(function(res) {
            console.log(res);
            if (res.error) {
              showError(res.error);
            } else {
              showInfo(res.message, res.links);
            }
            displayClaimNow();
          })
          .catch(function(err) {
            console.log(err);
            if (err.responseJSON && err.responseJSON.message){
              showError(err.responseJSON.message)
            } else {
              showError("communication error");
            }
            displayClaimNow();
          });
      }

      function showError(msg) {
        $("#hints").html(
          '<div class="alert alert-danger alert-dismissable fade show"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><h4>Ooops...</h4><p>' +
            msg +
            "</p></div>"
        );
      }
      function showInfo(msg, links) {
        let html = '<div class="alert alert-success alert-dismissable fade show"><button type="button" class="close" data-dismiss="alert" aria-label="Close"> <span aria-hidden="true">&times;</span> </button><h4>Well Done!</h4><p>' + msg+'</p>'
        for (const link of links){
          html += `<p><a href='${link.url}'>${link.text}</a></p>`
        }
        html+='</div>'
        $("#hints").html(html);
      }
    </script>
  </head>
  <body style="background:#f5f5f5">
    <div class="container">
      <div class="row" style="margin-top:5rem">
        <div
          class="col-sm-12 col-md-6 offset-sm-0 offset-md-3"
          style="background:white;padding:4rem 2rem 2rem 2rem; border-radius: 4px; border:1px solid #e7e7e7;"
        >
          <div class="row" style="margin-bottom:3rem;">
            <div class="col-8 offset-2">
              <a href="https://www.meter.io">
              <img src="/img/logo-green.png" class="img-fluid" alt="" />
             </a> 
            </div>
          </div>
          <h3 class="text-center">Claim your MTR token on 
            <span class="badge badge-dark" style='margin-bottom:50px;'><%= isMainnet ? 'Mainnet' : 'Testnet'%> </span>
          </h3> 
          <form id="claimForm" action="/taps" method="POST">
            <input
              class="form-control"
              placeholder="Type in your meter address"
              type="text"
              name="address"
            />

            <button
              id="submitBtn"
              class="btn btn-block btn-lg btn-primary"
              style="margin-top:10px"
              onclick="onSubmit(event)"
            />Claim Now</button>
            <div id="hints" style="margin-top:2rem"></div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
